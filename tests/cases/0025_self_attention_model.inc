#include "../../include/direct_space/graph.hpp"
#include "../../include/direct_space/node.hpp"
#include "../../include/direct_space/computation_table.hpp"
#include "../../include/direct_space/allocator.hpp"
#include "../../include/direct_space/engine.hpp"
#include "../../include/direct_space/stream.hpp"
#include "../../include/utility/wheels/cached_allocator.hpp"
#include "../../include/direct_space/session.hpp"
#include "../../include/direct_space/device.hpp"
#include "../../include/direct_space/tensor.hpp"
#include "../../include/utility/wheels/view.hpp"
#include "../../include/direct_space/layer.hpp"
#include "../../include/direct_space/model.hpp"

TEST_CASE( "self-attention-model-25", "[self-attention-model-25]" )
{

    spdlog::info( "\nTest case of 25 started.\n" );

    std::this_thread::sleep_for( std::chrono::seconds( 1 ) );

    using namespace nnl;
    auto& sess = get_default_session<default_engine_type>();
    sess.clean();

    //std::cout << "After cleaning, the session:\n" << sess << std::endl;

    std::int64_t const n_embd = 16;
    std::int64_t const n_seq = 16;

    auto input = make_tensor<default_engine_type>( {n_seq, n_embd}, "float32", "tensor_input" );
    auto w_p = make_tensor<default_engine_type>( {n_embd, n_embd}, "float32", "tensor_w_p" );
    auto w_q = make_tensor<default_engine_type>( {n_embd, n_embd}, "float32", "tensor_w_q" );
    auto w_k = make_tensor<default_engine_type>( {n_embd, n_embd}, "float32", "tensor_w_k" );
    auto w_v = make_tensor<default_engine_type>( {n_embd, n_embd}, "float32", "tensor_w_v" );
    auto b_p = make_tensor<default_engine_type>( {n_embd, }, "float32", "tensor_b_p" );
    auto b_q = make_tensor<default_engine_type>( {n_embd, }, "float32", "tensor_b_q" );
    auto b_k = make_tensor<default_engine_type>( {n_embd, }, "float32", "tensor_b_k" );
    auto b_v = make_tensor<default_engine_type>( {n_embd, }, "float32", "tensor_b_v" );
    auto gt = make_tensor<default_engine_type>( {n_seq, n_embd}, "float32", "tensor_gt" );

    // shape: (16, 16)
    float dw_q[]=
    {
        -2.424781324101176, 0.507532757319406, -1.089006156676107, -0.09637532250842051, 1.6902034169020195, 0.06467577658909263, 1.7003757994450535, 0.7224227483386412, 1.9573714748717932, -3.0907542610770684, -2.5779780499030975, -3.523211890638138, 0.12569357056206276, -1.4866525037711251, 0.827481409719355, -0.36529815452732806, -0.7453934395860387, 3.300765934762225, 0.2125773137925977, -1.0535432999728815, -2.968321563545163, 1.3814105450119638, 0.9056612220903897, -3.1743631815018376, -1.2904226651720394, -0.5242843234299788, -4.27818682240383, -1.556269033017549, 1.7984768403363809, -4.230215926504332, -0.018256334980968125, 2.7854844375534404, -2.241959404631017, -1.9075047624832386, -0.5650966810996126, 0.02865771028957176, -0.20551734718493275, -4.025690230521543, -2.5280679393157257, -0.7974604287124905, -1.6345319420054203, 1.2766660949843027, -1.644247313954817, -1.7402321562095089, 2.6992251324115872, -1.1633031123284872, -2.960548637051734, -1.0047780512010291, -1.4648517440549247, 0.42194958971629104, -0.09368277352236876, -1.6653515505717913, -1.768915370007153, -2.060654815165452, 1.7006119918617384, 3.0304416500887674, -1.115064775747077, 0.12930857617399494, -0.28093540896405267, -2.0239301883884417, -2.0463284297945807, -1.9627428315894986, -4.84831889818598, -2.5149064511750723, -0.09303791946507711, 0.8446882965137406, -1.414699396553054, -1.751839922418302, 0.27976794656040727, 3.107386472590763, -2.856670451620078, -2.549320066257615, -1.8742913113629829, 0.09583661921467579, -2.7082859069296727, -0.06868405599193528, -2.4419993468707633, 0.12452341211626461, -1.6297161522651518, -1.859794163737608, 0.6299908861424475, -3.370837618306812, -2.537254041556899, 0.4583309413612868, 0.5318220984505377, -0.5843998932977224, -5.374230546494666, 0.44393011481525746, -0.3024988122619554, -1.6772365082040166, -4.89078136303765, 0.6618113156042826, 2.498483580162024, 0.002274589874935229, 1.660633847345021, -2.31503453539578, -0.6301080992155625, -2.3021129579073607, -3.241013742768001, -1.6932135750952417, -2.82268956271471, -2.492270505333397, -2.541937057060085, -1.8279074276545662, -1.5836227750464522, -0.746454510548042, -3.494672313288786, -0.3656580785168989, -4.636842841318019, -0.8886156132141044, -0.838267623211312, -5.639695108777936, -1.6822423426406377, 1.1796922221065413, -0.09893764158144946, -1.9885972947957358, -2.093153483437745, -0.4159470203639851, -0.6915908146283185, 0.6346110380621584, -0.7124884392310658, 0.810343066357335, -0.19865266366791245, -2.5291877972459043, -3.03400405108826, -2.053978506598208, -0.18268270739068748, -2.735599629852314, 0.7835883320647754, -4.078128239708146, -1.5284948225240542, -2.8647185274404965, -0.3742425626678825, -0.7264193550095577, -1.303400382827388, -3.473675402203593, -2.7649807831936437, -2.3212649972102373, 0.9858982519093773, -2.2875941142440404, 0.002335375567203535, 0.8399702625840082, -2.6889528285076993, -2.0328856994043702, -5.413734190998983, -1.8062579936938699, 0.4266508384641394, -2.8932729219718, -0.2972769421302319, 0.577140958233852, -0.2799364248005193, -1.8764028746133865, -0.5433295910866958, -2.3507501152376107, -1.8385206440175674, 3.773491600998062, -2.016686465585014, -2.372472875598403, -0.6901928075958812, -0.44432768717360804, 0.5094100177580598, -2.5197695576462786, -3.109314354345826, -2.9553980104439823, 0.49474319108964804, 1.1513630683285938, -2.5149542106186393, -2.0216524683649073, -1.0512914918722542, -2.918079601205146, -1.9959427109447592, 0.8769209377151954, -3.4462234977947266, -0.26280983544577496, 1.3580694869704137, -3.1521829316243126, 1.1885501982002977, -0.9907721976491266, -2.0703667963304833, 0.7367550199017283, -0.8540177040518586, -1.4801214292773066, -2.155683312978681, -2.683343073743001, -2.1068052350271045, -1.4830106247783474, 0.5244616451180848, -1.5050351763576155, -0.4167189784707235, -1.77931105008662, -0.049624604412301876, -1.144726316447849, 1.5381161953751152, -0.48550198992009497, -4.328512872120496, -1.2434928668490657, -1.8830244623804973, 0.9104933848793106, -0.9600581550917083, 0.7256337870706886, 0.48709049226351375, -2.3251623300628794, -1.6103620551869495, -0.9171051956699768, -3.133925680761287, 5.8022114379613114, 0.050659199468762184, -3.5537556933192986, -3.8283089325830195, -0.7465399411721858, -1.7696981004056003, -4.101913842395325, -4.441590910275172, -0.9640357223871212, -1.9308829662071743, -0.19904523176630884, -1.2344789981412638, 1.2016725291132042, -4.660708046147998, 0.20387113764997578, -2.6270675233963954, -2.8719104431973257, 0.9260627573321567, -4.855755470472863, -1.17619253905494, -1.7236959267391947, 1.3900507496821835, -3.923011618984747, -0.29957373088915473, -0.05304872961973206, -1.036843618275154, -0.7846507108921728, -1.3115994163399973, -3.9269555132386906, -2.0669890054335234, -4.864712003018372, 0.8799584391488231, 0.9012139922121214, -3.82248526377434, 1.4094874619315432, -1.3566121243100056, -4.046427190704961, -2.464116770662355, 0.15030193161261507, -1.2064372545038915, -3.1580253912063325, 0.31172306464669863, -1.449358170867629, -2.027358409332585, -3.514507469946498, 0.004571555903444491, 0.6783870706411541, -3.11131779542313, -1.616751988573062, -1.5682076102143312, -0.6999326725225449,
    };

    // shape: (16, 16)
    float dw_k[]=
    {
        -3.188519025183385, 2.965850365191906, -0.4647802065357004, 0.7569197820477109, -1.6648189451484119, 3.1843372025859233, -0.1183852253631571, -4.624049106346882, 0.9924189339987073, -1.099905086793736, -3.1340796089384395, -1.118521667672722, -2.808209862965643, 0.40550675843826434, 0.21718462056831878, -3.787050451497452, 0.31733213364345025, 1.0923289928752675, -5.9915057646283945, 1.6087155595927873, 0.32180658343932556, 0.6449446032708568, 1.8534529009707308, -1.0973952212802185, -2.734031021904421, -0.2576814850401504, -1.3225479134566585, -0.10096697127400367, -5.653852423231039, -1.8316227320689982, 4.184168134800585, -0.2504637732618007, 0.9990477255589436, -0.32175666017300786, -1.6984382762318968, 0.68768411009001, 0.4838013577905407, -1.7039936446993305, -1.3809915663148116, 0.3445442449098053, -2.5993743989430613, -2.6893848942634033, 1.3445548541156938, 1.2981263768295803, -1.3876098448141143, 2.1332804547489572, 0.7158103619368472, -0.1804690299910061, -2.018001794583867, 0.5437740469736811, -2.0676871208842518, -1.1423024884482198, -2.2383694611885314, 1.4251896453060424, -0.7187723092504181, -0.960215584843788, 0.35864077481972534, 3.9794150633767726, 1.1050636301304295, -4.068193140456717, -0.9696501599942042, -0.7658950224190619, -2.115369246012958, -2.914131097634253, 2.434351919421038, 0.5556967851043748, 0.8926960148632961, -0.21490412452928453, 0.7248028163025182, 0.046490432501554935, -0.5968610808494613, -1.3300710464129342, -2.925321657533946, -2.4027360883698075, -1.0613359749513498, -2.7629251310626763, -0.2935784393994604, -2.782587584554592, 0.5819396433057629, -3.783532168588072, -0.3393954593547732, 1.5590174687533156, 0.7344253303996304, -2.041918041422818, 1.6408096135950183, -0.9186694296847675, -0.2698964039459838, -1.0904117772047215, -4.477035731114527, 0.14098669064230274, -0.1300479560366996, 0.517788928582325, -2.947676259054422, 0.6097701910358324, -2.289238361460998, -3.3404888498568006, -3.051821746568725, -0.5883676949868604, -1.808715343594274, 2.083615416937225, 0.6003057118117605, 1.294618004023806, -1.3244971058164379, -3.149493681186087, -4.200768236305647, -1.4441134551910864, 1.5501151807786537, 1.5134861366727788, -4.299119059799089, -0.44905710610748284, 0.41704903557119266, -2.9649207050763144, -0.9651061673938285, -2.4401167165614694, -0.6870465068162313, -0.5914903908511673, -1.6473580595005268, -1.222918084250312, -2.3559545105560855, -0.7787623828919155, -7.420861594536846, -0.044467820845070616, 1.0739936160798713, -3.637929107209977, -1.3884426676892763, 0.17557705860265083, -2.4136381625839456, -2.3722931702146917, -1.128686299231754, 0.4774288470685253, -3.7650949692731848, -0.5349147491533084, 0.06395311231070133, -3.740728485601901, -0.7026037438741926, 1.8920461268138573, -1.010274835912457, -1.319125748134102, 1.8731413394169958, -2.1590165786583393, -1.3248014598578464, 1.6782631672513437, 2.525428592994332, -3.1481615091237964, -1.3832633687709657, -0.032342321100893634, 1.5502516747889494, -0.07801069887899137, -2.1913712102145597, 0.5917539823183608, -5.466105696876234, -0.7159464241028565, 0.4840956534909684, 1.2228822560771704, -0.1004655848920909, -3.86079340315661, 0.885079544882265, -2.0702931852777953, -1.9179343364586474, 1.303057546352255, -4.954835417021611, 3.477297518365865, 0.8001699942345935, 0.7780647450478617, -1.3045931489889417, 0.40925378925244194, 0.22591013542919902, -0.5206736363463909, -4.02404294797557, -0.11060456779402583, -0.49355895048284304, 0.8815741367795955, -0.16539536022522094, -0.46088289338193666, -0.6625578751372043, -3.9779003385751914, -4.710533320756594, -1.2206434442324678, -2.40920952435724, -0.08936294594777583, -3.441343807430888, -2.130093036618452, 0.4123776232090892, -0.9899122038618462, -2.7465183587703486, 0.11203616258884974, -0.4652360488424854, -3.0638696543021204, -2.2718063789007985, -0.6004418057373788, -1.3930332860075587, -1.5297817882886822, -2.0723374136667365, -6.3879126344798625, -0.03732009539039438, -0.38381827504901644, -1.2750565363230406, -4.600731403395703, -1.8399716200908625, -1.0570674682661145, -1.4636263577721556, -1.2331499741763543, -5.472107554522716, 0.16665530030372344, 0.085088053862316, 0.2523345875910352, 1.5142514627629615, -0.6350358057393645, 1.623236093131283, -3.5097207829551174, 0.2701738001894456, -1.5377570031893666, 1.7227419291182517, -2.0452695222404857, -2.134478853668347, -2.369580088375039, -0.1192421788142648, -2.6769602804966657, 0.5997533465145672, 0.3580533660713934, -1.0024811222859082, -0.8373126472200418, -2.3742944240971204, 2.6733484414474575, 0.5142225482613474, -3.4171446621625416, 0.8772069397633435, -3.2933772990335917, -0.53835965436354, 0.09351582209157305, -1.815233265569264, -2.3366157888438783, -0.477120814358997, -0.06213070145657251, -0.7767394568687155, -0.43401898466487576, -3.939269250419134, -1.2927386194925707, -3.1671829316461886, -1.0002987855097139, -3.3054515009035197, -2.8268925704083063, -3.1053355961015976, -2.117221115820025, -1.8786660899584167, -1.570577916511304, -0.17611174670487273, -3.2228689614029418, 1.8290070333001607, -2.0925295944408804, -2.911738729942879, -0.7992894335841122, -2.2353781317284573, -2.357637168793677, -1.0292892112354883, -3.9221816780532532,
    };

    // shape: (16, 16)
    float dw_v[]=
    {
        0.5943396714761766, -4.143007664482061, -2.780429789870351, 0.7136201959941684, 0.8227503287214861, -0.71742136527206, -4.2317683769123935, -2.175530837520439, -2.610624669023424, -2.6883675172703834, -2.0521367171984366, -0.6612994483702013, 0.2989137922290541, -0.9319378068474895, -3.1098845076822514, -1.3243686050046508, -0.8916318521016298, 0.3613362724252924, -2.5918593499140297, -2.3059292634980055, -2.6485429159560923, -3.584269771960299, -0.5980720923440603, -2.455410549801342, 0.47211615547210606, 0.3320327241050318, -1.2931850134512781, -0.8430247728134519, -2.0780162680731333, -0.8915869374270144, -1.0714308132338746, 1.0078605675231547, -2.1872793536552875, 0.8821200871668005, 0.06344713186599327, -0.5208367912462841, -3.5390578557660786, -3.2007738777530634, -1.2482313858198688, -0.9526720388972714, -3.680348522290501, 2.2257966555463446, -0.8580529455602961, -1.4228312188364294, -0.10534969887618151, -2.6810739994768653, -5.298176619289597, -1.398964052222155, -2.571098368526353, -1.0986396551062885, -0.7685255453629882, -4.265292261897546, -2.6756245897488027, 0.6618854856300413, 1.7701887706711408, -1.22132887797968, -0.8089583314715714, -0.35986707965388076, -0.4573380419941506, 4.222730933002055, 2.3669918596268102, -2.2289667912865228, -1.578924023076988, 1.3403532750678, 0.19853904831141822, 0.9393242767988454, 0.3844297691297518, -2.625440587028764, -3.4231428319756287, -3.862937420639371, -2.3207643886300886, -0.11094490489463593, -2.0015613122662232, 3.0882857619695807, -4.121010618505413, -1.4655267912213434, 1.1364018180978834, 2.801295760972612, -2.8431421604053444, -0.3624209965500824, 0.44250389158871717, -4.899501992201265, 0.6280027571375968, -0.6306552988818486, -1.792715726111151, 0.9677320437463433, -0.8109982499241892, -2.465630339418328, 1.7189160625331414, -2.2310665261663614, 1.5881125934242086, -5.729392161315798, 0.8428709595111099, -1.5857604194238688, -0.3983145671920878, -0.6050880335031965, 1.0777075072996727, -2.6355092029184597, -1.3296484467673357, -1.5956136013785172, 0.012713497626372305, -0.9670750368257947, -0.3887863199083831, -0.2042231008826768, -4.2993382300327605, -1.3991205768872343, -0.7281064735337472, -0.5046784226769783, 4.006708093895076, 0.6761461333875023, 1.6726469684708625, -1.788872200689906, 0.7234444137494511, 2.699552771732292, -1.7860725856106248, -2.141732553274296, -3.906533125039889, -3.499153049856286, 2.44677270402611, -3.8530478561297783, -1.1020146567525013, 0.6469351424945977, -0.5466184566838717, -0.37623597600339365, -1.0639845156083527, 1.1054414693309065, -3.7265628184585347, -1.643411470592535, -1.0187501763551274, -4.667891992615096, -2.370115523827185, -1.3019891388413665, 2.0964004080205627, -2.1846305758392575, 1.426472865504711, -2.3458772422462504, 2.4112842334181503, -1.7496262954088981, 1.1649579272088233, 4.9325001943870825, 1.0444773459131818, 1.9833749248529036, -3.054298416698899, 0.21501720294281657, 0.5357014751732867, -1.31026996544912, -0.38577343558438626, -3.139304014589191, -1.8870098629566079, -3.4263991094446333, -4.004072044029481, 0.49935667596953626, -2.5954138780596043, -0.32854680310945716, 2.7406998154480946, 1.2218548749596332, -2.229492639197441, -1.4844009091546915, -2.279486104143306, -0.9697068048569062, 2.456022112741971, 2.2842672517705815, -2.0045968000790255, -3.7106022733993096, 1.1394526063628332, -5.560919652318169, 0.18302210679809638, -5.54205688671594, -0.14357129781842348, -0.5419784511428702, -1.8410995371820467, -3.2255561921172555, 0.10819406785395325, -0.08656460133312127, -0.6872844561556027, 3.7313471118928074, -1.4575203068057152, -2.036655513761156, 1.8930287881016667, 5.203727076624637, -2.2043955128030452, -1.3206640029525363, -1.870416093201234, -0.34893546605436765, 0.6846257722548876, -2.3816995418685307, -1.4117485074780205, -2.8353646692367054, -0.526567505929226, -1.4772174259498092, -0.14466570945312474, -1.41358786927425, -0.6398365211938467, -4.259756969425851, -2.1942822537111137, -1.7908547787871583, -0.5830107080681415, -3.1033690286357536, -2.0310686913164138, 0.9851195133555102, -0.09241997760835052, -2.273953734191562, -1.0164751407907107, -1.6411351950912818, -0.5025086226748792, -1.5534849735502148, -2.8574051886510023, -0.7506902821043425, -4.039203552587426, 0.3390168698290077, 0.9796225158200629, 0.781830529622207, -3.7292906840361697, -1.2457790967998674, 0.7325924944110207, -0.5055640939092086, -0.3322453682578336, -0.65365076515845, 0.6479069841678855, -1.249106770309853, -4.184662338386149, -0.3529305706167001, 3.398640901760121, 0.5234441886804564, 0.3292461087803076, 3.008575631248352, -2.432184797952477, -2.901293973138257, -1.7239609480590277, 0.022920805080320905, 2.7070112670866266, 1.3014920642501435, -0.980974689964408, 2.040266830879484, -0.24114345260964243, -0.2449918483358764, -1.1983783555198704, -2.6871638641380353, -1.3075647219415671, -2.822754778929151, -5.026719495781859, -2.5288944954161954, 1.7969539467088, -1.4254917140658263, -3.726921924994922, -0.5971969989094352, 3.8770201340399035, -1.0997087902754432, 4.067030031387643, 0.24737109083307152, -4.971688321971131, -0.18852399578792878, 3.4169614762838822, 0.17421228989363513, -3.1936918804000984, -0.03176316030768578,
    };

    // shape: (16,)
    float db_q[]=
    {
        1.8317298918422886, -3.9340233871338492, -0.5391943532868619, -0.13610620921715144, 1.3563411607265912, -1.5780700173558704, -2.545355504773464, 0.46434141037482357, -0.14065481110471667, -0.9142922806606422, -1.7708356213769951, 0.873306437244374, -1.8214154859600313, 3.6115689691991806, -1.5189187592471292, 1.7512982793922314,
    };

    // shape: (16,)
    float db_k[]=
    {
        1.3291563275068596, 0.05985565283893135, -1.1049476961820952, 1.4069844645905332, -0.5950536558581248, -2.614459050854067, -0.6313790360891423, 0.004711880719263872, -4.3251047000686444, 1.3817167747875856, -4.6385986646545865, -0.40001772485098896, -1.0688792407628245, -4.349749118400373, -1.3788194774402072, -3.017729082413461,
    };

    // shape: (16,)
    float db_v[]=
    {
        -0.16961906853186315, -2.236564767409557, -0.4748635411925165, -0.2071001640765694, 1.2956241020011738, -2.690373063458126, 2.4818676286839896, -5.071128312398894, -3.2057335950691654, -1.911984968087574, -4.375117485685987, -4.561583107648785, -0.3791352250687302, -4.552008144331634, -2.626041903248712, 0.5953451381653774,
    };

    // shape: (16, 16)
    float dw_p[]=
    {
        1.2818182426636633, -1.7689988172414686, 0.42008339744849144, 0.5449774870728974, 0.06627190508242009, -1.5853720992069897, -2.9655170218074547, -3.8940433054760706, 1.7948805379752826, 0.006207585528954507, -1.314268112941318, -1.1848355412670224, 0.5312630252078743, 0.8047587563200354, -1.1647046278311635, -3.2019822460774248, 0.5337009945587887, -1.8591875141956664, -4.035825592283873, 1.6635178984710786, 2.704581935686037, -0.34378044389557216, -1.1130119516812096, -1.274041111931854, -1.7201445769434405, -1.9706948184828228, -2.7230087182163154, -2.748324092819817, -2.191415065375689, -1.366882636481791, -0.8896448956198848, -0.16186379043843102, -3.1762106376691324, 0.10293834970615223, -3.0531192702639824, -3.1328214736406017, -0.21452198747078133, -4.6290205381753085, -1.362312692562327, -5.110412342605523, -2.1585077783500966, 0.15201499345396807, 0.5092960043679033, -3.3411186285083496, -3.234047265230884, 2.0090578966252677, -0.2792391094406176, 1.736309750313756, -4.219559236707245, 1.8083294400496945, -0.3428670882214139, -3.5582293859757708, -0.9208183164023263, 1.898453279455525, 0.1447272429486508, -3.4526992800191505, -4.250653656296189, 1.3091317816762191, -1.6796711549505345, -2.6882506536559214, -2.0880919257729538, -2.554935740091615, -4.015534998942286, -1.5492021048622833, -0.5499849555672789, -4.06227258889299, 1.0164651643290301, -2.737458636806035, -0.5078168459369168, 0.5812271453902416, 0.6447312804534537, 1.8837313383276495, -4.589558170291708, -5.091927984223894, -4.28804302498752, -2.312969655943084, -0.25423805925317755, -3.4578354977786048, -3.3026931877117174, -2.1661857386133825, -2.3894525669174103, 3.1837664339435268, -3.221282932316213, 2.4358524013496483, 3.443307707311142, -1.3639610221287946, -1.5007199100679995, -1.3927233456818686, -2.4688764241657717, -2.347054330612712, -3.7858703605927326, -0.38275100766885317, 0.6738968535158776, -2.738107810639751, 0.5062138272312928, -2.114659352248781, -2.571072990736604, -0.930122322712356, -1.814345372181466, 2.242323926793524, 1.6509337830474378, 1.6015220517110937, 0.5405571315864568, -3.734478459285671, -2.2207604739762554, -1.322114168179243, 2.456378768046101, -2.7085438714956322, 1.3602633794270402, -5.005038592838503, -1.9973123661253112, -1.7908937216394405, 1.147406645039196, 0.9637040600880584, -0.7854176134660911, -0.13045997652789976, -3.7226501531889844, -4.642961461356476, 1.2000394195179047, 4.602306310028392, 1.104666757176414, -1.9061293485148065, 0.06929926890954463, -4.706013409820741, -1.3898968342877596, -1.6527259581417308, 1.6948939305385244, -0.40200830894867945, 0.9977997726655581, -3.731502602017584, -1.5045258478647527, -2.58730588425422, 0.7113575738251718, -0.4155486514944521, -0.659341763094522, -5.066930596058643, 2.5737138008777074, -1.6571104670742676, -0.9355462377218018, 4.134245154857888, 2.104691382344714, -0.5807924802552931, 0.45752988920567117, -3.6003633680111364, -2.5357738163035486, 0.5445128973432336, -2.040251076819705, -1.5286638876332757, -3.9097891644981817, -2.3662559757898873, -2.3186413129106676, -2.066907494016392, 2.5696424621826552, -1.2572043804376447, -0.8290887024454807, 1.2725502569299616, -1.607625771853993, 0.39901374052448824, -4.727133914880366, -1.6904467997862205, 0.09228431164868334, -2.4748121004099346, 0.001197847915675343, -1.6910283368870607, 0.22505387876942362, 1.1700144786335422, -1.4606669502599403, -3.305148552786326, -3.0197400854940026, -0.8501028991281195, -1.1094882165653248, -4.280343212878391, 0.9956260594349566, 1.462489177629008, -1.0039094196888922, -0.39255121886282596, -0.3988094272430249, -2.9054322788077824, -1.0701421735086596, -0.3569836110894258, -1.3479448025620573, -3.6698507339742035, -4.0203886485530305, -2.398554549723931, -2.483191607492822, -2.627316826881832, -5.447027713275897, -1.7715905562157261, -2.2502324348369873, -1.4794542372409665, -3.8788083158065723, -0.12152956074998467, -1.1712548046937943, 0.5629631793536736, -2.723736587376062, 0.2870746937745139, -0.6112222128049816, -2.025128032113133, -0.9266771507110452, -2.9093860233260074, -1.4327658903271847, -1.2704538195545048, -1.382680405087276, -0.6939694371334236, 0.17735076370891778, -3.3960819939332563, -0.34904251838337275, -5.744203076853911, -3.346060357569171, 3.047909907148931, 0.28125455758048123, -1.2111030462014478, 3.9305888549622994, -3.1058151924277895, -1.6123956271622113, -3.471556137265799, -0.3740745018249616, -2.765151124242563, -5.208993960137985, -4.056033204745095, -2.629132677845167, 0.06903805041330213, -0.3972994724153258, 0.2656488109460966, -0.5720828643319043, -2.5123803540295304, 2.4248950575887878, -2.5337045802828753, -0.3491392137063529, -2.5347660839939374, -2.0835244482970703, -1.801700620964394, -3.1270951811770535, 0.5229310214480778, -1.3263725768930907, 0.7467381441339487, 1.3901601267218564, 0.1351268187401522, -0.7929543068028495, -0.11204302835278424, -2.3981302811302636, -0.3735557241913393, -5.401743891572986, -3.0478270217794092, 0.267094167375584, -4.47223122420807, -0.6959777369014247, 0.23032991265518166, -1.2491209354392407, -3.0355362027479424, 0.6402622266151232, 2.906021296326707, 1.6010181687771867, -4.246629933045616, 2.4100537820249466, -2.397577947303163,
    };

    // shape: (16,)
    float db_p[]=
    {
        1.90811156868069, -1.1608877295442515, 0.11464409811766285, 1.754974140066453, -3.105137881083032, 1.632136714746824, -1.0496593939801575, 0.32416722471943515, -1.2951581913260644, -1.5593891495626506, -3.8605226431459707, -1.5977249567800893, 0.6018585187032508, -2.9386391394281572, 1.6434846291205325, 0.2301629138415504,
    };

    // shape: (16, 16)
    float dgt[]=
    {
        -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185191871466, -112.54776526171918, -431.51604292439254, -407.2331605468445, 219.13620309583334, -398.7846598371049, -228.72988992806305, -681.1151825226503, -516.9406169772263, -375.1914035392109, -373.6106292151814, -253.0347404688075, -65.05411174379414, -410.8644173001616, -207.03557057000504, -333.59307695170884, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -513.6185339628211, -112.54777087192481, -431.51605705879604, -407.233173709002, 219.1362195058611, -398.7846696199918, -228.7298947820306, -681.1152130368274, -516.9406224171412, -375.19141495940096, -373.61062925942997, -253.03472832160503, -65.0540995957222, -410.8644292016733, -207.035564342988, -333.59309579633896, -606.072632909705, -218.6743088648824, -370.9468103468271, -477.40106626894453, 203.11256234665456, -448.85543607001046, -378.43678357850547, -772.9072085463414, -887.5972280751353, -556.0466052316733, -787.5480401996002, -598.782451112343, -147.33844258341134, -571.4130488157248, -497.0503902083134, -444.9431265467096, -606.072632909705, -218.6743088648824, -370.9468103468271, -477.40106626894453, 203.11256234665456, -448.85543607001046, -378.43678357850547, -772.9072085463414, -887.5972280751353, -556.0466052316733, -787.5480401996002, -598.782451112343, -147.33844258341134, -571.4130488157248, -497.0503902083134, -444.9431265467096, -267.36801921214914, 50.717599020491825, -322.00607954714184, 38.309662042142484, 75.69390238380882, -222.40797325484405, -98.99274477644234, -180.68380037012807, -363.29941966845126, -201.11001011701197, -163.6112513972468, -216.5315915105081, -11.572165288793405, -359.8338926899525, -122.48720660737392, -241.90271573929394, -606.072632909705, -218.6743088648824, -370.9468103468271, -477.40106626894453, 203.11256234665456, -448.85543607001046, -378.43678357850547, -772.9072085463414, -887.5972280751353, -556.0466052316733, -787.5480401996002, -598.782451112343, -147.33844258341134, -571.4130488157248, -497.0503902083134, -444.9431265467096,
    };

    // shape: (16, 16)
    float dinput[]=
    {
        -3.994972124064682, -1.172833130699365, -0.2621229503472994, -1.3682119922087392, -0.31900618195677544, 0.8587464877289082, -1.867529435252254, -0.16011678358866466, -1.5031162108781584, -3.089622407006583, -0.16175671100151212, -2.146700798194215, -1.6103370095727128, 0.4549284091421928, -5.224883196920529, 0.022504758070215125, -0.39671406586997937, -0.862398715220549, -0.04722884447080611, -0.5241677901339763, -0.25271611022442764, -4.307046764570108, -2.049343954418358, -0.6866117262239151, -1.478400349499391, -0.8926272574989687, -2.8341699905724984, 2.3940258796259144, -1.0191287031703056, 0.3433068422189032, 0.6874342744168596, -2.0953437490469584, -2.1324288880334414, -3.2304486924664118, -0.19991100453312705, 1.6092802499052126, 0.3274187397230679, -3.8530118128747524, 1.0460916532296856, 1.2406239685984048, -0.4957718292314063, -4.345843734642292, -4.955665696441919, -2.4691694818551753, -4.1448893666045095, -0.3760080682636272, 1.5108202074944046, 1.7558383588220794, 0.845573877523824, 1.063697765286442, 1.189909150228163, -0.6408078404387658, -2.668347427566605, 2.816921734788516, 2.770085159060373, -5.160277200403959, 1.6302918533818098, -0.35593754362856855, -2.092987268566535, 2.167101481580517, -2.608335873517732, -1.3528842499223002, -0.8758007465963615, 1.6747375900475956, -2.1153613909639377, -0.41329636244156087, -1.9110656564340949, -0.1250150053029, 2.1281426584490157, 1.6640785338627686, -0.6102780667418553, -0.6008834278950465, -3.542783710204748, 1.924650882099229, -0.27258504022864216, 2.1535955820519614, -0.037494441728071704, -0.43106279142229253, -0.8143407209640858, -3.812888536558626, 1.0208477755128254, 0.946224306810787, -1.9526636971358786, 0.31272079163856104, -0.3770936655589542, -1.8027462869085062, -2.286641124126462, -3.4214451684149307, -2.666161136551114, 1.5208421569458497, 0.9751190434342094, -0.5279985991460934, 1.4743671937861644, -0.3572008201011133, -1.5518447259154131, 0.32175195573927984, -1.12413806809916, -1.2490503768341923, 0.26837848030966294, -2.939746433591477, 1.8994887212986846, 0.11425716768595207, -1.8966043586356083, 0.6962064186908135, -3.1147559247872225, -3.6887107785959525, -1.4308864791013156, -0.15128574957404928, -2.0629070767513182, -3.1043409254257197, 3.3605319686678277, -0.040856147163571666, -2.778774383439127, -1.3657357134847778, 1.110871431152498, -0.8492774724042111, -3.1659236308211334, 4.112317428354647, 2.4812722695852703, -3.6330845032143655, 0.9262701730974965, 0.666324259875426, -2.3080916849039137, -1.2742785056740626, -2.0330516981168056, 0.29026429021216704, 2.9279639593001057, -0.3022931040301965, -1.3314974502323818, 2.477381728191768, -0.739799446079273, -2.3329919689125393, -1.9344166581867763, -1.583692742130744, 0.6278924883841996, 1.2023202042061216, 1.4594395493908512, 1.2271386968667857, -3.942226458237919, 0.497924040827741, -3.055776066453489, -0.1525153733234711, -0.3626412879030869, -2.0228495865430585, -1.6318335909515405, -1.563825494230048, -0.020956395286881202, -0.22051413126448638, 2.875663717823728, -0.08332844715644716, 0.45049397108201417, 0.16163283812940743, -0.9045057384101401, 1.2142972296593189, -2.1575465241485405, -0.13470903094941167, -2.009124325344141, -1.1651347865209107, -4.184650103989427, -3.53100343471487, 0.872391685747367, -0.21449241326459245, 0.6034255489847911, -1.2222793092911093, -2.493994322065327, 0.43828271384077433, 1.3747692221351517, -2.71347813563455, -5.2030700975355355, -1.8523270454304017, -0.9824492594924664, -4.076673897682124, -3.457106387729855, 0.19954491926745765, 1.6188222640796592, 2.342196766156058, -1.5516207444909456, 0.0676054943590989, -1.123741169504488, -2.857576542219992, -1.945713431267375, 0.5007385264509319, -2.980527957476404, -2.2177229903421622, -1.0365165434341788, -2.3320600638417517, -3.1907238053851064, -1.6340999543891614, 1.5732223153249634, -0.3433732131377587, -2.746394169377269, -0.3248888958471997, -1.8822126352084563, 0.021864814191719262, -0.9402493771234044, -3.4357454478753353, -2.199325783495956, -0.5347497673922288, -0.4903762044398171, -1.6943391248561603, -0.1919535027746937, -2.9115683331786695, -2.1033791927176013, -1.6745792619201088, -5.4691007358225905, -0.06537635554187393, -2.5051731539491087, -1.1652556063651485, -3.0927463812385745, 0.45181400413225536, -1.5242790079848954, -2.1085542093246143, 1.2322741239028088, -2.139315274307761, -4.318226354493938, 1.6608037248049352, -1.9605183573030747, -3.0444885339633907, -1.6857347681524861, 1.5433877879363496, -0.1301806577149478, -2.708020674031517, -0.8128321316808493, 3.9304178043293723, 0.7795979028832221, 1.4769965084916707, -1.8060869208853465, -1.2685346014352092, 3.196949833744519, -1.6199733195370403, 0.0009599453125834767, 0.7967823222551391, 0.6317322058772152, -1.221043551000536, 0.9905366772598092, -1.7515036598002238, -3.0929882876469694, -0.014060471491494586, -0.7757942388373804, -1.950440074856433, -0.9917697969533792, -3.4375245678291675, -0.14188346181755707, 1.3152090184555432, -4.601128561686824, -2.8187196928949083, -2.1249347801754004, -3.351430989210875, -0.4664988663219557, 1.9533705170786453, -0.7036483863767871, 1.7874946173513515, -0.6659552688010659, -0.06483644008809686, -1.8155212244389207, -0.23828575306599764,
    };







    w_q.import_from( dw_q );

    w_k.import_from( dw_k );

    w_v.import_from( dw_v );

    b_q.import_from( db_q );

    b_k.import_from( db_k );

    b_v.import_from( db_v );

    w_p.import_from( dw_p );

    b_p.import_from( db_p );

    gt.import_from( dgt );

    input.import_from( dinput );

    auto input_layer = Input( "InputLayer" );
    auto output_layer = SelfAttention( w_q, b_q, w_k, b_k, w_v, b_v, w_p, b_p, "Attention_Layer_model_25" )( input_layer );
    auto m = model( input_layer, output_layer );
    auto outputs = m.predict( input );
    auto output = outputs[0];

    output.save_txt( "./output.txt" );

    auto mat = view_2d{ reinterpret_cast<float*>( gt.data() ), static_cast<std::uint64_t>(n_seq), static_cast<std::uint64_t>(n_embd) };
    auto nat = view_2d{ reinterpret_cast<float*>( output.data() ), static_cast<std::uint64_t>(n_seq), static_cast<std::uint64_t>(n_embd) };
    for ( auto r : range( n_seq ) )
        for ( auto c : range( n_embd ) )
        {
            if ( std::abs(mat[r][c]-nat[r][c]) > 1.0e-2 )
            {
                spdlog::error( "gt[{}][{}]={}, pred[{}][{}]={}", r, c, mat[r][c], r, c, nat[r][c] );
            }
            REQUIRE( std::abs(mat[r][c]-nat[r][c]) < 1.0e-2 );
        }

}

